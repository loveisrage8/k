<head>
  <link rel="stylesheet" href="./static/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="./static/css/style.css" type="text/css">
</head>
<div class="row">
  <div class="col">
    <table style="margin: 0;" class="table table-borderless">
      <thead>
        <tr>
          <th style="text-align: left;" scope="col">Account</th>
          <th style="text-align: right;" scope="col">Remove</th> <!-- Move up/down? -->
        </tr>
      </thead>
    </table>
    <div style="max-height: 300px; overflow: auto;" class="table-wrapper">
      <table id="accountsTable" class="table table-striped table-borderless">
        <tbody>
        </tbody>
      </table>
    </div>
    <table class="table table-borderless">
        <tbody>
          <tr>
            <form action="index.html" method="post" onsubmit="addUserForm();return false;">
              <th style="text-align: center;">
                <!-- <input id="userForm0" style="width: auto;" type="text" placeholder="Username" required> -->
                <div style="margin-top: 0;" class="group">
                  <input style="width: auto;" id="userForm0" type="text" required="">
                  <span style="width: auto;" class="bar"></span>
                  <label>Username</label>
                </div>
              </th>
              <th style="text-align: center;">
                <!-- <input id="userForm1" style="width: auto;" type="password" placeholder="Password" required> -->
                <div style="margin-top: 0;" class="group">
                  <input style="width: auto;" id="userForm1" type="password" required="">
                  <span style="width: auto;" class="bar"></span>
                  <label>Password</label>
                </div>
              </th>
              <th style="padding-right: 0px;">

                  <svg onclick="userForm1Reveal(this)"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"style="cursor: pointer; position: relative; left: -15px; top: 15px; height: 30px;">
                    <path d="M15.5 12a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0z"></path>
                    <path fill-rule="evenodd" d="M12 3.5c-3.432 0-6.125 1.534-8.054 3.24C2.02 8.445.814 10.352.33 11.202a1.6 1.6 0 000 1.598c.484.85 1.69 2.758 3.616 4.46C5.876 18.966 8.568 20.5 12 20.5c3.432 0 6.125-1.534 8.054-3.24 1.926-1.704 3.132-3.611 3.616-4.461a1.6 1.6 0 000-1.598c-.484-.85-1.69-2.757-3.616-4.46C18.124 5.034 15.432 3.5 12 3.5zM1.633 11.945c.441-.774 1.551-2.528 3.307-4.08C6.69 6.314 9.045 5 12 5c2.955 0 5.309 1.315 7.06 2.864 1.756 1.553 2.866 3.307 3.307 4.08a.111.111 0 01.017.056.111.111 0 01-.017.056c-.441.774-1.551 2.527-3.307 4.08C17.31 17.685 14.955 19 12 19c-2.955 0-5.309-1.315-7.06-2.864-1.756-1.553-2.866-3.306-3.307-4.08A.11.11 0 011.616 12a.11.11 0 01.017-.055z"></path>
                  </svg>

              </th>
              <th style="padding-left: 0px;">
                <button style="position: relative; top: 6;" type="submit" class="btn">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M22 4.25a.75.75 0 00-1.5 0v15a.75.75 0 001.5 0v-15zm-9.72 14.28a.75.75 0 11-1.06-1.06l4.97-4.97H1.75a.75.75 0 010-1.5h14.44l-4.97-4.97a.75.75 0 011.06-1.06l6.25 6.25a.75.75 0 010 1.06l-6.25 6.25z"></path></svg>
                </button>
              </th>
            </form>
          </tr>
        </tbody>
      </table>
  </div>

  <div class="col">
    <table style="margin: 0;" class="table table-borderless">
      <thead>
        <tr>
          <th style="text-align: left;" scope="col">Reason</th>
          <th style="text-align: right;" scope="col">Enabled</th>
        </tr>
      </thead>
    </table>
    <div style="max-height: 360px; overflow: auto;" class="table-wrapper">
      <table id="reasonsTable" class="table table-striped table-borderless">
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

</div>

<div style="height: 200px; margin: 10px; margin-top: 15;" class="row console shadow">
  <div id="consoleOut" style="max-height: 170px; overflow: auto; width: 1100px;" class="table-wrapper">
  </div>
</div>

<div style="margin: 10px; margin-top: 30px;" class="row">
  <table class="table table-borderless">
    <tbody>
      <tr>
        <form onSubmit="startReport(); return false;" action="index.html" method="post">
          <div style="margin-top: 0;" class="group">
            <input style="width: auto;" id="targetForm" type="text" required="">
            <span style="width: auto;" class="bar"></span>
            <label>Target</label>
          </div>
          <button style="padding: 0px; margin-left: 50px;" type="submit" class="btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30"><path d="M9.5 15.584V8.416a.5.5 0 01.77-.42l5.576 3.583a.5.5 0 010 .842l-5.576 3.584a.5.5 0 01-.77-.42z"></path><path fill-rule="evenodd" d="M12 2.5a9.5 9.5 0 100 19 9.5 9.5 0 000-19zM1 12C1 5.925 5.925 1 12 1s11 4.925 11 11-4.925 11-11 11S1 18.075 1 12z"></path></svg>
          </button>
        </form>
        <button style="padding: 0px; margin-left: 50px;" onclick="stopReport()" type="submit" class="btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30"><path d="M12 7a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0112 7zm0 10a1 1 0 100-2 1 1 0 000 2z"></path><path fill-rule="evenodd" d="M7.328 1.47a.75.75 0 01.53-.22h8.284a.75.75 0 01.53.22l5.858 5.858c.141.14.22.33.22.53v8.284a.75.75 0 01-.22.53l-5.858 5.858a.75.75 0 01-.53.22H7.858a.75.75 0 01-.53-.22L1.47 16.672a.75.75 0 01-.22-.53V7.858a.75.75 0 01.22-.53L7.328 1.47zm.84 1.28L2.75 8.169v7.662l5.419 5.419h7.662l5.419-5.418V8.168L15.832 2.75H8.168z"></path></svg>
        </button>
        <button style="padding: 0px; margin-left: 50px;" onclick="clearConsole()" type="submit" class="btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30"><path fill-rule="evenodd" d="M16 1.75V3h5.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H8V1.75C8 .784 8.784 0 9.75 0h4.5C15.216 0 16 .784 16 1.75zm-6.5 0a.25.25 0 01.25-.25h4.5a.25.25 0 01.25.25V3h-5V1.75z"></path><path d="M4.997 6.178a.75.75 0 10-1.493.144L4.916 20.92a1.75 1.75 0 001.742 1.58h10.684a1.75 1.75 0 001.742-1.581l1.413-14.597a.75.75 0 00-1.494-.144l-1.412 14.596a.25.25 0 01-.249.226H6.658a.25.25 0 01-.249-.226L4.997 6.178z"></path><path d="M9.206 7.501a.75.75 0 01.793.705l.5 8.5A.75.75 0 119 16.794l-.5-8.5a.75.75 0 01.705-.793zm6.293.793A.75.75 0 1014 8.206l-.5 8.5a.75.75 0 001.498.088l.5-8.5z"></path></svg>
        </button>
      </tr>
    </tbody>

  </table>

</div>
<!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade" id="inputModal" tabindex="-1" role="dialog"  aria-hidden="true" data-keyboard="false" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div style="background-color: lightskyblue; opacity: 0.8;" class="modal-content">
      <div class="col">
        <table class="table table-borderless">
          <tbody>
            <tr>
              <h5 style="padding: 10px; text-align: center;">Input from python</h5>
            </tr>
            <tr>
              <h6 style="border: 1px solid black; padding: 10px;" id="inputText">olaola</h6>
            </tr>
            <tr>
              <form onSubmit="sendInputPY(); return false;" class="" action="index.html" method="post">
                <th>
                  <div style="margin-top: 0;" class="group">
                    <input style="width: 360px; padding: 6px;" id="inputPYForm" api="false" type="text" required="">
                    <span style="width: 360px;" class="bar"></span>
                    <label style="color: gray;">Input</label>
                  </div>
                </th>
                <th>
                  <button type="submit" class="btn btn-primary">Send</button>
                </th>


              </form>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script type="text/javascript">
  function getParamValue(paramName)
  {
      var url = window.location.search.substring(1); //get rid of "?" in querystring
      var qArray = url.split('&'); //get key-value pairs
      for (var i = 0; i < qArray.length; i++)
      {
          var pArr = qArray[i].split('='); //split key and value
          if (pArr[0] == paramName)
              return pArr[1]; //return value
      }
  }
  const iframeID = [6,getParamValue('id')];

  document.addEventListener("iframe-focus", function(e) {
    if (e.detail == 'enabled') init();
    if (e.detail == 'disabled') destroy();
  });

  document.addEventListener("api-response", function(e) {
    if (e.detail.name == 'getAccounts'){
      refreshAccountTable(e.detail.res)
    } else if(e.detail.name == 'addAccount' || e.detail.name == 'removeAccount'){
      parent.sendToPython(iframeID, 'getAccounts', iframeID[1])
    } else if(e.detail.name == 'getReportReasons'){
      refreshReasonsTable(e.detail.res)
    } else if(e.detail.name == 'updateReportReason'){
      parent.sendToPython(iframeID, 'getReportReasons', iframeID[1])
    } else if(e.detail.name == 'consoleOut'){
      writeToConsole(e.detail.res)
    } else if(e.detail.name  == 'reportBotTarget'){
      writeToConsole(e.detail.res)
    } else if(e.detail.name == 'startInputClient'){
      console.log(e.detail.res)
    } else if(e.detail.name == 'inputFromPY'){
      document.getElementById('inputPYForm').setAttribute('api', e.detail.api)
      noColorText = ''
      for (var i = 0; i < Object.keys(e.detail.res).length; i++) {
        noColorText += e.detail.res[i]['text']
      }
      document.getElementById('inputText').innerText = noColorText
      $('#inputModal').modal('show')
    }
  });

  function refreshReasonsTable(data){
    table = document.getElementById("reasonsTable")
    table.lastElementChild.remove()
    table.append(document.createElement('tbody'))
    for (var iter in data){
      table.lastElementChild.insertRow()
      th = document.createElement('th');
      th.innerHTML = data[iter]['reasonName']
      th.classList.add('font-weight-light')
      table.lastElementChild.lastElementChild.appendChild(th)
      td = document.createElement('td')
      td.style = "text-align: center;"
      a = document.createElement('a')
      svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      a.setAttribute('onClick', "parent.sendToPython(["+iframeID+"], 'updateReportReason', ["+iter+", "+iframeID[1]+"])")
      svg.setAttribute('xmlns', "http://www.w3.org/2000/svg")
      svg.setAttribute('viewbox', "0 0 24 24")
      svg.setAttribute('width', "24")
      svg.setAttribute('height', "24")
      svg.style.align="center"
      svg.style.cursor = "pointer"
      path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('fill-rule', "evenodd")
      if (data[iter]['reasonEnabled'] == true) path.setAttribute('d', "M21.03 5.72a.75.75 0 010 1.06l-11.5 11.5a.75.75 0 01-1.072-.012l-5.5-5.75a.75.75 0 111.084-1.036l4.97 5.195L19.97 5.72a.75.75 0 011.06 0z")
      else if (data[iter]['reasonEnabled'] == false) path.setAttribute('d', "M5.72 5.72a.75.75 0 011.06 0L12 10.94l5.22-5.22a.75.75 0 111.06 1.06L13.06 12l5.22 5.22a.75.75 0 11-1.06 1.06L12 13.06l-5.22 5.22a.75.75 0 01-1.06-1.06L10.94 12 5.72 6.78a.75.75 0 010-1.06z")
      svg.appendChild(path)
      a.appendChild(svg)
      td.appendChild(a)
      table.lastElementChild.lastElementChild.appendChild(td)
    }
  }

  function refreshAccountTable(data){
    table = document.getElementById("accountsTable")
    table.lastElementChild.remove()
    table.append(document.createElement('tbody'))
    for (var user in JSON.parse(data)){
      table.lastElementChild.insertRow()
      th = document.createElement('th');
      // th.setAttribute('scope','row')
      th.innerHTML = user
      th.classList.add('font-weight-light')
      th.style = "text-align: left;"
      table.lastElementChild.lastElementChild.appendChild(th)
      td = document.createElement('td')
      td.style = "text-align: center; width: 75px;"
      a = document.createElement('a')
      svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      a.setAttribute('onClick', "parent.sendToPython(["+iframeID+"], 'removeAccount', ['"+user+"', "+iframeID[1]+"])")
      svg.setAttribute('xmlns', "http://www.w3.org/2000/svg")
      svg.setAttribute('viewbox', "0 0 24 24")
      svg.setAttribute('width', "24")
      svg.setAttribute('height', "24")
      svg.style.align="center"
      svg.style.cursor = "pointer"
      path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('fill-rule', "evenodd")
      path.setAttribute('d', "M5.72 5.72a.75.75 0 011.06 0L12 10.94l5.22-5.22a.75.75 0 111.06 1.06L13.06 12l5.22 5.22a.75.75 0 11-1.06 1.06L12 13.06l-5.22 5.22a.75.75 0 01-1.06-1.06L10.94 12 5.72 6.78a.75.75 0 010-1.06z")
      svg.appendChild(path)
      a.appendChild(svg)
      td.appendChild(a)
      table.lastElementChild.lastElementChild.appendChild(td)
    }
  }

  function userForm1Reveal(arg){
    let passField = document.getElementById('userForm1');
    if (passField.type == "password"){
      passField.type = "text"
      arg.firstElementChild.setAttribute('d', "M8.052 5.837A9.715 9.715 0 0112 5c2.955 0 5.309 1.315 7.06 2.864 1.756 1.553 2.866 3.307 3.307 4.08a.11.11 0 01.016.055.122.122 0 01-.017.06 16.766 16.766 0 01-1.53 2.218.75.75 0 101.163.946 18.253 18.253 0 001.67-2.42 1.607 1.607 0 00.001-1.602c-.485-.85-1.69-2.757-3.616-4.46C18.124 5.034 15.432 3.5 12 3.5c-1.695 0-3.215.374-4.552.963a.75.75 0 00.604 1.373z")
      arg.lastElementChild.setAttribute('d', "M19.166 17.987C17.328 19.38 14.933 20.5 12 20.5c-3.432 0-6.125-1.534-8.054-3.24C2.02 15.556.814 13.648.33 12.798a1.606 1.606 0 01.001-1.6A18.305 18.305 0 013.648 7.01L1.317 5.362a.75.75 0 11.866-1.224l20.5 14.5a.75.75 0 11-.866 1.224l-2.651-1.875zM4.902 7.898c-1.73 1.541-2.828 3.273-3.268 4.044a.118.118 0 00-.017.059c0 .015.003.034.016.055.441.774 1.551 2.527 3.307 4.08C6.69 17.685 9.045 19 12 19c2.334 0 4.29-.82 5.874-1.927l-3.516-2.487a3.5 3.5 0 01-5.583-3.949L4.902 7.899z")
    } else if (passField.type == "text"){
      passField.type = "password"
      arg.firstElementChild.setAttribute('d', "M15.5 12a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0z")
      arg.lastElementChild.setAttribute('d', "M12 3.5c-3.432 0-6.125 1.534-8.054 3.24C2.02 8.445.814 10.352.33 11.202a1.6 1.6 0 000 1.598c.484.85 1.69 2.758 3.616 4.46C5.876 18.966 8.568 20.5 12 20.5c3.432 0 6.125-1.534 8.054-3.24 1.926-1.704 3.132-3.611 3.616-4.461a1.6 1.6 0 000-1.598c-.484-.85-1.69-2.757-3.616-4.46C18.124 5.034 15.432 3.5 12 3.5zM1.633 11.945c.441-.774 1.551-2.528 3.307-4.08C6.69 6.314 9.045 5 12 5c2.955 0 5.309 1.315 7.06 2.864 1.756 1.553 2.866 3.307 3.307 4.08a.111.111 0 01.017.056.111.111 0 01-.017.056c-.441.774-1.551 2.527-3.307 4.08C17.31 17.685 14.955 19 12 19c-2.955 0-5.309-1.315-7.06-2.864-1.756-1.553-2.866-3.306-3.307-4.08A.11.11 0 011.616 12a.11.11 0 01.017-.055z")
    }
  }

  function addUserForm(){
    parent.sendToPython(iframeID, 'addAccount', [document.getElementById('userForm0').value, document.getElementById('userForm1').value, iframeID[1]])
    document.getElementById('userForm0').value = ''
    document.getElementById('userForm1').value = ''
  }

  function startReport(){
    writeToConsole({"0":{"text":"Sending start request.","color":"blue"}})
    target = document.getElementById("targetForm")
    parent.sendToPython(iframeID, 'reportBotTarget', [iframeID[1], target.value])
    parent.document.getElementById("chgBtn_"+iframeID[1]).innerText = 'Reporting - '+target.value
  }

  function stopReport(){
    writeToConsole({"0":{"text":"Sending stop request.","color":"blue"}})
    parent.sendToPython(iframeID, 'stopReportBot', iframeID[1])
    parent.document.getElementById("chgBtn_"+iframeID[1]).innerText = 'Stopped'
  }

  function clearConsole(){
    stream = document.getElementById("consoleOut")
    stream.innerText = ''
  }

  function writeToConsole(msg){
    console.log(msg)
    if(msg != 'undefined' && msg != null){
      stream = document.getElementById("consoleOut")
      lastScrollMax = stream.scrollHeight - stream.clientHeight
      tr = document.createElement("tr")

      for (var i = 0; i < Object.keys(msg).length; i++) {
        span = document.createElement("span")
        span.innerText = msg[i]['text']
        switch (msg[i]['color']) {
          case 'yellow':
            msg[i]['color'] = '#c7c700'
            break;
          default:
        }
        span.style.color = msg[i]['color']
        tr.appendChild(span)
      }

      stream.appendChild(tr)
      if(stream.scrollTop == lastScrollMax) stream.scrollTop = stream.scrollHeight

    }
  }

  function sendInputPY(){
    $('#inputModal').modal('hide')
    let input_py = document.getElementById('inputPYForm')
    parent.sendToPython(iframeID, 'handleInput', ['ReportBot', input_py.value, input_py.getAttribute('api')])
    input_py.value = ''
  }

  function init(){
    stream = document.getElementById("consoleOut")
    stream.scrollTop = stream.scrollHeight
    console.log('reportbot iframe init')
    parent.sendToPython(iframeID, 'getAccounts', iframeID[1])
    parent.sendToPython(iframeID, 'getReportReasons', iframeID[1])
  }

  function destroy(){
    console.log('reportbot iframe destroy')
  }

</script>
